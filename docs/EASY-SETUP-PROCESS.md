# Easy NixOS Setup Process

This document outlines the streamlined process for setting up a new NixOS host with your flake configuration.

## Overview

The setup process is designed to work seamlessly with the standard NixOS installation process:

1. **Boot NixOS ISO** → Standard NixOS setup
2. **Run ZFS script** → Automated drive configuration with optimizations  
3. **Run nixos-install** → Standard NixOS installation
4. **Run post-install script** → Automatic flake deployment

## Step-by-Step Process

### 1. Boot to NixOS Installation ISO

- Use NixOS unstable ISO with graphical environment
- Ensure you have network connectivity
- Choose LTS kernel for maximum hardware compatibility

### 2. SSH with Agent Forwarding (Recommended)

For seamless authentication, SSH into the target machine with agent forwarding:

```bash
# From your development machine, SSH with agent forwarding
ssh -A root@TARGET_IP_ADDRESS
```

This allows you to use your SSH keys on the target machine for git operations.

### 3. Partition and Configure Storage

Clone the repository using SSH and run the ZFS installation script:

```bash
# Clone the repository using SSH (works with agent forwarding)
git clone git@github.com:Bakan0/nixconf.git
cd nixconf

# Run the ZFS installation script with your target drive
./docs/install-zfs.sh /dev/nvme0n1
```

This script will:
- Set up LUKS2 encryption with TPM2 auto-unlock (if available)
- Create optimized ZFS pool with proper tuning
- Configure EFI boot partition
- Generate ZFS-specific optimizations
- Create base NixOS configuration

### 4. Install Base NixOS

After the ZFS script completes successfully, run the standard NixOS installation:

```bash
nixos-install
```

This creates a minimal bootable system with the ZFS optimizations already included.

### 5. Initialize Host Configuration

After `nixos-install` completes, initialize your host configuration:

```bash
# Initialize the new host (automatically detects hardware and creates configs)
./docs/flake-init.sh HOSTNAME

# Example for ironclad:
./docs/flake-init.sh ironclad
```

This script will:
- Copy the real hardware-configuration.nix generated by nixos-install
- Create optimized configuration.nix and home.nix for your host
- Update flake.nix with the new host entries  
- **Automatically commit and push changes** (when using SSH agent forwarding)

### 6. Deploy and Reboot

Choose your deployment method:

**Option A: Local deployment**
```bash
# Deploy locally on the target machine
nixos-rebuild switch --flake .#HOSTNAME --show-trace
reboot
```

**Option B: Remote deployment (faster builds)**
```bash
# From your development machine (after the target reboots)
nixos-rebuild switch --flake ~/nixconf#HOSTNAME --target-host root@TARGET_IP --show-trace
```

### 5. Reboot and Enjoy

```bash
# Exit chroot and reboot
exit
umount -R /mnt
reboot
```

Your system will boot into your fully configured NixOS environment with:
- ✅ ZFS with optimizations
- ✅ TPM2 auto-unlock (if supported)
- ✅ Complete Hyprland desktop environment
- ✅ All your applications and configurations
- ✅ Terracotta/atomic theming (for hearth)

## Available Hosts

Currently configured hosts in the flake:
- `acc01ade` - General desktop
- `mariposa` - Butterfly themed
- `petalouda` - Butterfly themed (Greek)
- `nighthawk` - Performance focused
- `tyr` - Norse themed
- `dazzle` - MacBook setup
- `hermit` - Laptop configuration
- `hearth` - **NEW** Home bastion with terracotta/atomic theming
- `ironclad` - Dell Precision 5530 battle-tested workstation

## Future Updates

Once your system is deployed, use the standard flake workflow:

```bash
# Update flake and rebuild
cd ~/nixconf
git pull
nh os switch . -- --show-trace

# Or for quick updates
nh os switch ~/nixconf/.
```

## Troubleshooting

### If flake deployment fails:
1. Check that the hostname exists in `flake.nix`
2. Verify network connectivity during setup
3. Ensure hardware configuration was properly generated
4. Check for typos in the configuration files

### If ZFS setup fails:
1. Ensure the drive is not in use: `lsblk /dev/nvmeXnX`
2. Check for sufficient disk space
3. Verify TPM2 is enabled in BIOS (for auto-unlock)
4. Try again with a clean drive

### Theme Issues (Hearth):
The terracotta/atomic theme is automatically applied to the `hearth` host. If colors don't appear correctly:
1. Ensure Stylix is properly imported
2. Check that the terracotta-atomic.nix file exists
3. Rebuild with `--show-trace` for detailed error messages

## What Makes This "Easy"

1. **No manual partitioning** - ZFS script handles everything
2. **Hardware detection preserved** - Uses actual `nixos-install` output
3. **One-command deployment** - Post-install script does everything
4. **TPM2 auto-unlock** - No password typing after setup (where supported)
5. **Optimized by default** - ZFS tuning, performance settings, etc.
6. **Immediate usability** - Full desktop environment ready on first boot

This process eliminates the complexity of manual NixOS setup while preserving all the power and customization of your flake configuration.